<?xml version="1.0" encoding="utf-8" ?>
<component name="ChefProfileTask" extends="Task">
  <interface>
    <field id="apiUrl" type="string" />
    <field id="supabaseKey" type="string" />
    <field id="chefId" type="string" />
    <field id="response" type="assocarray" />
  </interface>
  <script type="text/brightscript">
    <![CDATA[
    sub init()
        m.top.functionName = "executeRequest"
    end sub

    sub executeRequest()
        m.port = CreateObject("roMessagePort")
        http = CreateObject("roUrlTransfer")
        url = m.top.apiUrl + "/get-chef-details"
        
        http.SetUrl(url)
        http.SetCertificatesFile("common:/certs/ca-bundle.crt")
        http.InitClientCertificates()
        http.SetPort(m.port)
        
        ' Anti-Cache Mechanism: Roku Network cache is aggressive
        cacheBust = CreateObject("roDateTime").AsSeconds().ToStr()
        finalUrl = url + "?cb=" + cacheBust
        http.SetUrl(finalUrl)
        
        ' üî• MAGIA: Obliga a Roku a mostrar el error real de Supabase
        http.RetainBodyOnError(true)
        
        ' Verificamos si las llaves est√°n llegando al Task
        if m.top.supabaseKey <> invalid and m.top.supabaseKey <> ""
            http.AddHeader("apikey", m.top.supabaseKey)
            http.AddHeader("Authorization", "Bearer " + m.top.supabaseKey)
            print "[ChefProfileTask] Auth Headers a√±adidos correctamente."
        else
            print "[ChefProfileTask] ‚ö†Ô∏è ADVERTENCIA: supabaseKey est√° vac√≠o o inv√°lido."
        end if
        
        http.AddHeader("Content-Type", "application/json")
        
        ' Armamos y verificamos el payload forzando las MAY√öSCULAS
        chefIdStr = ""
        if m.top.chefId <> invalid then chefIdStr = m.top.chefId
        
        ' Creamos el arreglo de forma expl√≠cita para que BrightScript respete "chefId"
        json = CreateObject("roAssociativeArray")
        json["chefId"] = chefIdStr 
        payload = FormatJson(json)
        
        print "[ChefProfileTask] Enviando payload corregido a Supabase: " + payload
        
        http.AsyncPostFromString(payload)
        
        msg = wait(0, m.port)
        if type(msg) = "roUrlEvent"
            code = msg.GetResponseCode()
            if code = 200
                m.top.response = ParseJson(msg.GetString())
                print "[ChefProfileTask] ‚úÖ Datos recibidos correctamente."
            else
                print "ChefProfileTask Error: " + Str(code)
                print "Error Details (La verdad revelada): " + msg.GetString()
                m.top.response = {}
            end if
        end if
    end sub
    ]]>
  </script>
</component>
